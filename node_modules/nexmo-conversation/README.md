# Conversation SDK for JavaScript

## Quick Steps

- [x] [Create your Nexmo account](https://dashboard.nexmo.com/sign-up)
- [x] [Install ```nexmo-cli``` tool](https://github.com/Nexmo/nexmo-cli)
- [x] [Create a new application](https://github.com/Nexmo/nexmo-cli#create-a-new-application)
- [x] [Generate a JWT token](https://github.com/Nexmo/nexmo-cli/tree/develop#jwt)
- [X] [Register your new user to the Conversation Service](https://docs-ea.nexmo.com/conversation) (Step 4)
- [x] [Generate a JWT token](https://github.com/Nexmo/nexmo-cli/tree/develop#jwt) (with sub=`[username]`)

## Setup

```shell
$ npm install nexmo-conversation
```

create a nexmo application using the nexmo-cli

```shell
$ nexmo app:create "Application name" --type rtc --keyfile private.key
>Application created: xxxxxxxx-xxxx-xxxx-xxxx-xxxxsxxxxxxx
>Private Key saved to: private.key
```

get a token to create a user:

```shell
$ nexmo jwt:generate private.key application_id=[application_id]
```

create a user in your app

```shell
 $ curl -X POST -H 'Authorization: Bearer [JWT]' -H 'Content-Type:application/json' -d '{"name":"[username]"}' https://api.nexmo.com/beta/users

```

include the script in your web page

```HTML
<script src="node_modules/nexmo-conversation/dist/conversationClient.js"></script>
```

get a user's token

```shell
$ nexmo jwt:generate private.key application_id=[application_id] sub=[username]
```

## Usage

### Create an instance and login

```javascript
var rtc = new ConversationClient({debug:false});
// var token = request login token as above, with sub=<username>
rtc.login(token).then(
    function(application){
        // use the application object to manage the conversations
        // access the available conversations
        console.log(application.conversations);
    });
```

### Create a new Conversation

```javascript
var conversationData = {
    display_name:'Nexmo Conversation'
    };
application.newConversation(conversationData).then(
    function(conversation) {
        // join the created conversation
        conversation.join().then(
            function(member) {
                console.log("Joined as " + member.user.name);
            });
    }).catch(function(error) {
    console.log(error);
});
```

### Get a conversation you are a member of

```javascript
application.getConversation(conversation_id).then(
    function(conversation) {
         // console.log(conversation);
        });
```

### Set up Text listener for incoming Text Events

```javascript
conversation.on("text", function(sender, textEvent){
    if (textEvent.cid === conversation.id){
        // if (rtc.isVisible) { textEvent.seen(); }
        console.log("message received:", textEvent, sender);
    }
});
```

### Sending a Text Event

```javascript
conversation.sendText("Hi Nexmo").then(function(){
        console.log('message was sent');
    }).catch(function(error){
        console.log('error sending the message', error);
    });
```

## Login Create a conversation, join it, send a message and listen for incoming messages

```javascript
var rtc = new ConversationClient({debug:false});
// var token = request login token as above, with sub=<username>
rtc.login(token).then(
    function(application){
        // access the available conversations
        console.log(application.conversations);
        // you might already have conversations under `application.conversations[]` to get,
        // or join (if application.conversations[xxx].me.state === "joined" || "invited" respectively)

        application.newConversation().then( //not providing a name, the service will assign a random one for you
            function(conversation) {
                // join the created conversation
                // you can also find your user_id under rtc.application.me (as application === rtc.application)
                conversation.join().then(
                    function(member) {
                        console.log("Joined as " + member.user.name); //member.id is your member's id
                    });

                // listen for incoming text messages
                conversation.on("text", function(sender, textEvent){
                        // manage seen indication
                        // if (rtc.isVisible) { textEvent.seen(); }
                        console.log("message received:", textEvent, sender);
                });

                // send a text event to the conversation
                conversation.sendText("Hi Nexmo").then(
                    function(){
                        console.log('message was sent');
                    }).catch(function(error){
                        console.log('error sending the message', error);
                });
            }).catch(function(error) {
            console.log(error);
        });
    });
```

The main objects here are `application` and `conversation` you can use them to extend the use case.
E.g. by inviting a second user to a conversation that you are a member (have joined).
The second instance should see the conversation listed, and the member(or me).state as "invited"
When both instances have attached listener to "text" events of a conversation they have both joined,
you should be able to send/receive text events in that conversation.

## Build

If you want to contribute:

### Install SDK

clone this repo and enter in it's directory

```shell
$ npm install
```

### build

```shell
$ npm start
```

it will build interracially your code.

or

```shell
$ npm run build
```

### generate docs

```shell
$ npm run docs
```

it will generate your code in ```dist/conversationClient```

### Run the tests

you can run the test with

```shell
$ npm run test
```




[![NEXMO](https://www.nexmo.com/wp-content/themes/nexmo/resources/img/nexmo_logo_157x43_fullcolor.png)](https://www.nexmo.com)
